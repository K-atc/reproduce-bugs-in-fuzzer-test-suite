TARGET := reproducer
TARGET_NOASAN := $(TARGET).noasan

EXTLIB_DIR_NAME := c-ares
LIBXML2_LIB_DIR := $(EXTLIB_DIR_NAME)/.libs
EXTLIB_LIB := $(LIBXML2_LIB_DIR)/libcares.a
FUZZER_TEST_SUITE_TARGET_CC := ../../fuzzer-test-suite/c-ares-CVE-2016-5180/target.cc

CFLAGS := -g
CFLAGS_ASAN := $(CFLAGS) -fsanitize=address
CFLAGS_NOASAN := $(CFLAGS)

all: $(TARGET) $(TARGET_NOASAN)
	@

clean:
	rm -f $(TARGET) $(TARGET_NOASAN) $(EXTLIB_LIB)

$(EXTLIB_LIB):
	cd $(EXTLIB_DIR_NAME) && git checkout -f 51fbb479f7948fca2ace3ff34a15ff27e796afdd
	cd $(EXTLIB_DIR_NAME) && ./buildconf && ./configure --disable-shared
	cd $(EXTLIB_DIR_NAME) && make -j $(nproc)

define build_main
	$(CXX) $(1) -I $(EXTLIB_DIR_NAME) \
		$< $(FUZZER_TEST_SUITE_TARGET_CC) \
		$(EXTLIB_LIB) \
		-static-libasan \
		-o $@
endef

$(TARGET): ../main.cpp $(EXTLIB_LIB)
	$(call build_main,$(CFLAGS_ASAN))

$(TARGET_NOASAN): ../main.cpp $(EXTLIB_LIB)
	$(call build_main,$(CFLAGS_NOASAN))


reproduce: $(TARGET)
	./$(TARGET) ../../fuzzer-test-suite/libxml2-v2.9.2/crash-50b12d37d6968a2cd9eb3665d158d9a2fb1f6e28