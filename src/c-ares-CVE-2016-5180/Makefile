TARGET := reproducer
TARGET_NOASAN := $(TARGET).noasan
PROJECT_ROOT_DIR_REL := ../..
PROJECT_ROOT_DIR := $$(realpath $(PROJECT_ROOT_DIR_REL))
CRASH_INPUT := $(PROJECT_ROOT_DIR_REL)/input/c-ares-CVE-2016-5180/crash-13ca0cd4d46367c279afde95e0128266bad0a7ba

EXTLIB_DIR_NAME := c-ares
EXTLIB_LIB := $(EXTLIB_DIR_NAME)/.libs/libcares.a
FUZZER_TEST_SUITE_TARGET_CC := $(PROJECT_ROOT_DIR)/fuzzer-test-suite/c-ares-CVE-2016-5180/target.cc

CC := clang
CXX := clang++
CFLAGS := -g -O2
CXXFLAGS := $(CFLAGS)
CFLAGS_ASAN := $(CFLAGS) -fno-omit-frame-pointer -gline-tables-only -fsanitize=address,fuzzer-no-link -fsanitize-address-use-after-scope
CFLAGS_NOASAN := $(CFLAGS)

all: $(TARGET) $(TARGET_NOASAN)
	@

clean:
	rm -f $(TARGET) $(TARGET_NOASAN) $(EXTLIB_LIB)
	cd $(EXTLIB_DIR_NAME) && git clean -dfx

$(EXTLIB_LIB):
	cd $(EXTLIB_DIR_NAME) && git checkout -f 51fbb479f7948fca2ace3ff34a15ff27e796afdd
	cd $(EXTLIB_DIR_NAME) && ./buildconf
	cd $(EXTLIB_DIR_NAME) && CC=$(CC) CFLAGS="$(CFLAGS)" ./configure --disable-shared
	cd $(EXTLIB_DIR_NAME) && make -j $(nproc)

define build_main
	$(CXX) $(1) \
		$(EXTLIB_LIB) $(FUZZER_TEST_SUITE_TARGET_CC) $^ \
		-I $(EXTLIB_DIR_NAME) \
		-o $@
endef

$(TARGET): ../main.cpp $(EXTLIB_LIB)
	$(call build_main,$(CFLAGS_ASAN))
	nm $@ | grep asan > /dev/null

$(TARGET_NOASAN): ../main.cpp $(EXTLIB_LIB)
	$(call build_main,$(CFLAGS_NOASAN))
	nm $@ | grep ares_create_query > /dev/null

reproduce:
	ASAN_OPTIONS=strip_path_prefix=$(PROJECT_ROOT_DIR)/ ./$(TARGET) $(CRASH_INPUT)